From 7e7eec77e77e549eb96fa6647c5147af6a006c8b Mon Sep 17 00:00:00 2001
From: Sandro-Alessio Gierens <sandro@gierens.de>
Date: Sun, 5 Oct 2025 18:14:00 +0200
Subject: [PATCH] cvisor: add hardcoded pkvm-constants.S to fix build on nixos

Signed-off-by: Sandro-Alessio Gierens <sandro@gierens.de>
---
 arch/x86/kvm/Makefile              |  6 +--
 arch/x86/kvm/pkvm/pkvm-constants.S | 67 ++++++++++++++++++++++++++++++
 2 files changed, 70 insertions(+), 3 deletions(-)
 create mode 100644 arch/x86/kvm/pkvm/pkvm-constants.S

diff --git a/arch/x86/kvm/Makefile b/arch/x86/kvm/Makefile
index 3edc131d83f0..aa84475a7e66 100644
--- a/arch/x86/kvm/Makefile
+++ b/arch/x86/kvm/Makefile
@@ -49,9 +49,9 @@ $(obj)/kvm-asm-offsets.h: $(obj)/kvm-asm-offsets.s FORCE
 pkvm-intel-$(CONFIG_PKVM_INTEL)	+= vmx/pkvm_init.o
 
 $(obj)/vmx/pkvm_init.o: $(obj)/pkvm/pkvm_constants.h
-$(obj)/pkvm/pkvm-constants.s: $(src)/pkvm/pkvm_constants.c FORCE
-	$(call if_changed_dep,cc_s_c)
-$(obj)/pkvm/pkvm_constants.h: $(obj)/pkvm/pkvm-constants.s FORCE
+# $(obj)/pkvm/pkvm-constants.s: $(src)/pkvm/pkvm_constants.c FORCE
+# 	$(call if_changed_dep,cc_s_c)
+$(obj)/pkvm/pkvm_constants.h: $(obj)/pkvm/pkvm-constants.S FORCE
 	$(call filechk,offsets,__PKVM_CONSTANTS_H__)
 CFLAGS_vmx/pkvm_init.o    := -iquote $(obj)/pkvm
 
diff --git a/arch/x86/kvm/pkvm/pkvm-constants.S b/arch/x86/kvm/pkvm/pkvm-constants.S
new file mode 100644
index 000000000000..9a48692483ce
--- /dev/null
+++ b/arch/x86/kvm/pkvm/pkvm-constants.S
@@ -0,0 +1,67 @@
+	.file	"pkvm_constants.c"
+# GNU C11 (GCC) version 14.3.0 (x86_64-unknown-linux-gnu)
+#	compiled by GNU C version 14.3.0, GMP version 6.3.0, MPFR version 4.2.2, MPC version 1.3.1, isl version isl-0.20-GMP
+
+# GGC heuristics: --param ggc-min-expand=100 --param ggc-min-heapsize=131072
+# options passed: -mno-sse -mno-mmx -mno-sse2 -mno-3dnow -mno-avx -m64 -mno-80387 -mno-fp-ret-in-387 -mpreferred-stack-boundary=3 -mskip-rax-setup -march=x86-64 -mtune=generic -mno-red-zone -mcmodel=kernel -mstack-protector-guard-reg=gs -mstack-protector-guard-symbol=__ref_stack_chk_guard -mindirect-branch=thunk-extern -mindirect-branch-register -mindirect-branch-cs-prefix -mfunction-return=thunk-extern -mharden-sls=all -mrecord-mcount -mfentry -O2 -std=gnu11 -p -fzero-call-used-regs=used-gpr -fshort-wchar -funsigned-char -fno-common -fno-PIE -fno-strict-aliasing -fcf-protection=branch -falign-jumps=1 -falign-loops=1 -fno-asynchronous-unwind-tables -fno-jump-tables -fpatchable-function-entry=16,16 -fno-delete-null-pointer-checks -fno-allow-store-data-races -fstack-protector-strong -ftrivial-auto-var-init=zero -fno-stack-clash-protection -fmin-function-alignment=16 -fstrict-flex-arrays=3 -fno-strict-overflow -fstack-check=no -fconserve-stack -fno-builtin-wcslen -frandom-seed=9d750qkg3d
+	.text
+	.section	.text.startup,"ax",@progbits
+	.align 16
+	.globl	main
+	.section	__patchable_function_entries,"awo",@progbits,.LPFE226
+	.align 8
+	.quad	.LPFE226
+	.section	.text.startup
+.LPFE226:
+	nop	
+	nop	
+	nop	
+	nop	
+	nop	
+	nop	
+	nop	
+	nop	
+	nop	
+	nop	
+	nop	
+	nop	
+	nop	
+	nop	
+	nop	
+	nop	
+	.type	main, @function
+main:
+	endbr64
+1:	call	__fentry__
+	.section __mcount_loc, "a",@progbits
+	.quad 1b
+	.previous
+# arch/x86/kvm/pkvm/pkvm_constants.c:7: 	DEFINE(PKVM_VMEMMAP_ENTRY_SIZE, sizeof(struct pkvm_page));
+#APP
+# 7 "arch/x86/kvm/pkvm/pkvm_constants.c" 1
+	
+.ascii "->PKVM_VMEMMAP_ENTRY_SIZE $4 sizeof(struct pkvm_page)"	#
+# 0 "" 2
+# arch/x86/kvm/pkvm/pkvm_constants.c:9: }
+#NO_APP
+	xorl	%eax, %eax	#
+	jmp	__x86_return_thunk
+	.size	main, .-main
+	.ident	"GCC: (GNU) 14.3.0"
+	.section	.note.GNU-stack,"",@progbits
+	.section	.note.gnu.property,"a"
+	.align 8
+	.long	1f - 0f
+	.long	4f - 1f
+	.long	5
+0:
+	.string	"GNU"
+1:
+	.align 8
+	.long	0xc0000002
+	.long	3f - 2f
+2:
+	.long	0x1
+3:
+	.align 8
+4:
